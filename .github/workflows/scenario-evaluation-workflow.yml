---

name: üíª Full Scenario Evaluation

on:
  push:
    branches:
      - test-results-check-1148

  workflow_dispatch:
    inputs:
      tactic_dir:
        type: choice
        description: 'Tactic Directory'
        required: false
        default: 1000-evaluation
        options:
        - 10-reconnaissance
        - 20-resource-development
        - '...'
        - 120-impact
        - 1000-evaluation

      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false


jobs:
  matrix_generator:
    name: Matrix Generator
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: üêÑ Got git?
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üë©‚Äçüíª Generating Matrix
        id: generate-matrix
        run: |
          echo "::set-output name=matrix::$(find ./scenario_configs -type f -name "*.json" | jq -cnR '[inputs | select(length>0)]')"


  matrix_job:
    runs-on: ubuntu-latest
    # needs: matrix_generator
    strategy:
      matrix:
        # scenario_path: ${{ fromJson(needs.matrix_generator.outputs.matrix) }}
        scenario_path:
          - scenario_configs/cifar10_baseline.json
          - scenario_configs/mnist_baseline.json
    steps:
      - name: üêÑ Got git?
        uses: actions/checkout@v3

      - name: üêç Setup Environment
        uses:  ./.github/actions/evaluations_environment_setup

      # - name: Install Prerequisites
      #   run: |
      #     source .venv/bin/activate

      - name: üöÄ Run Scenario Evaluation
        timeout-minutes: 30
        working-directory: .github/workflows/
        env:
          ARMORY_INSTALL: "/tmp"
          HOME: "/tmp"
        run: |
          SCENARIO_PATH=`echo "${{ matrix.scenario_path }}" | awk '{gsub(/.*[/]|[.].*/, "", $0)} 1'`
          SCENARIO_DIR="/tmp/${SCENARIO_PATH}"

          mkdir -p "${SCENARIO_DIR}"

          mkdir -p "${HOME}/.armory"
          cp ./tests/scenario-evaluation-config.json "${HOME}/.armory/config.json"

          python ./bin/scenario-evaluation-workflow.py run-scenario ${{ matrix.scenario_path }} 2>&1 | tee /tmp/scenario_evaluation.log
      # | tee "${SCENARIO_DIR}/scenario_evaluation.log"
      # pytest -c pyproject.toml --verbose --show-capture=no -s ./tests/end_to_end/test_scenario_runner.py

      - name: üìÅ Archiving Artifacts
        uses: actions/upload-artifact@v3
        # if: ${{ !failure() }}
        continue-on-error: true
        with:
          name: evaluation-artifacts
          retention-days: 1
          path: |
            /tmp/scenario_evaluation.log
            /tmp/.armory/outputs

      # Enable tmate debugging of manually-triggered workflows if the input option was provided
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 5
        if: ${{ failure() && github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}


  # debugger:
  #   name: Debugger
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: üìù Echo Environs
  #       shell: python
  #       run: |
  #         print(__import__(os).environ)
